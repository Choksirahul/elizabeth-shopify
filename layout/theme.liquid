<!doctype html>
<html>
  <head>
    <title>{{ page_title }}</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="content-type" CONTENT="text/html;charset=UTF-8">

    <script defer src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <meta name="description" content="{{ page_description | escape }}">
    <link rel="canonical" href="{{ canonical_url }}">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">

    {{ content_for_header }}
    <!-- Header hook for plugins -->
    {{ 'application.css' | asset_url | stylesheet_tag }}
    {% comment %} {{ 'application.js' | asset_url | script_tag }} {% endcomment %}

    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  </head>
  <body>
    {% section 'header' %}
    <!-- Add this to your theme.liquid or the relevant template file -->
    <main role="main" class="flex-grow">
      {{ content_for_layout }}
    </main>

    {% if customer %}
      <p>
        Welcome {{ customer.first_name }}
        {{ customer.last_name }}, {{ customer.email }}!
      </p>
    {% else %}
      <p>Welcome, Guest!</p>
    {% endif %}

    {% comment %} <a href="https://shopify-b2c-login.onrender.com/auth" class="btn">Login with Azure B2C</a> {% endcomment %}

    <script>
      document.getElementById('shopify-logout').addEventListener('click', function (event) {
        event.preventDefault();
        var shopifyLogoutUrl = this.href;
        var azureB2CLogoutUrl =
          'https://keeprdev.b2clogin.com/keeprdev.onmicrosoft.com/oauth2/v2.0/logout?p=B2C_1_SignUpSignIn&post_logout_redirect_uri=https://shopify-b2c-login.onrender.com/auth/callback';

        // Log out from Shopify and then redirect to Azure AD B2C logout
        fetch(shopifyLogoutUrl, {
          method: 'GET',
          credentials: 'same-origin',
        })
          .then(function (response) {
            window.location.href = azureB2CLogoutUrl;
          })
          .catch(function (error) {
            console.error('Error logging out from Shopify:', error);
            window.location.href = azureB2CLogoutUrl; // Redirect to Azure B2C logout even if Shopify logout fails
          });
      });
    </script>
  </body>
</html>
